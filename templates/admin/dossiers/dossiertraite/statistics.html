{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block extrahead %}{{ block.super }}
<script type="text/javascript" src="{% url 'admin:jsi18n' %}"></script>
{{ form.media }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block extrastyle %}{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static "admin/css/forms.css" %}">
<style>
    .stats-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }
    .stat-number {
        font-size: 2.5em;
        font-weight: bold;
        color: #2196f3;
        margin: 10px 0;
    }
    .stat-label {
        color: #666;
        font-size: 1.1em;
    }
    .chart-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin: 20px 0;
    }
    .table-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin: 20px 0;
    }
    .stats-table {
        width: 100%;
        border-collapse: collapse;
    }
    .stats-table th, .stats-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    .stats-table th {
        background: #f5f5f5;
        font-weight: bold;
    }
    .btn-primary {
        background: #2196f3;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        margin: 5px;
    }
    .btn-primary:hover {
        background: #1976d2;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
    &rsaquo; <a href="{% url 'admin:dossiers_dossiertraite_changelist' %}">Dossiers traités</a>
    &rsaquo; Statistiques
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>Statistiques des dossiers traités</h1>
    
    <div class="stats-section">
        <h2>Vue d'ensemble</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ total_dossiers }}</div>
                <div class="stat-label">Total des dossiers</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ dossiers_avec_avis }}</div>
                <div class="stat-label">Dossiers avec avis</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ dossiers_sans_avis }}</div>
                <div class="stat-label">Dossiers sans avis</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ dossiers_avec_avis|floatformat:1 }}%</div>
                <div class="stat-label">Taux de traitement</div>
            </div>
        </div>
    </div>
    
    <div class="stats-section">
        <h2>Répartition par université</h2>
        <div class="chart-container">
            <canvas id="universitesChart" width="400" height="200"></canvas>
        </div>
        <div class="table-container">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Université</th>
                        <th>Nombre de dossiers</th>
                        <th>Pourcentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in universites_stats %}
                    <tr>
                        <td>{{ stat.universite }}</td>
                        <td>{{ stat.count }}</td>
                        <td>{{ stat.count|floatformat:1 }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="stats-section">
        <h2>Répartition par pays</h2>
        <div class="chart-container">
            <canvas id="paysChart" width="400" height="200"></canvas>
        </div>
        <div class="table-container">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Pays</th>
                        <th>Nombre de dossiers</th>
                        <th>Pourcentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in pays_stats %}
                    <tr>
                        <td>{{ stat.pays }}</td>
                        <td>{{ stat.count }}</td>
                        <td>{{ stat.count|floatformat:1 }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="stats-section">
        <h2>Évolution mensuelle</h2>
        <div class="chart-container">
            <canvas id="evolutionChart" width="400" height="200"></canvas>
        </div>
    </div>
    
    <div class="stats-section">
        <h2>Actions</h2>
        <a href="{% url 'admin:dossiers_dossiertraite_changelist' %}" class="btn-primary">
            Retour à la liste des dossiers
        </a>
        <a href="{% url 'admin:dossiers_dossiertraite_import_excel' %}" class="btn-primary">
            Importer depuis Excel
        </a>
        <a href="{% url 'admin:dossiers_dossiertraite_export_excel' %}" class="btn-primary">
            Exporter vers Excel
        </a>
        <a href="{% url 'admin:dossiers_dossiertraite_bulk_edit' %}" class="btn-primary">
            Modification en masse
        </a>
    </div>
</div>

<script>
// Graphique des universités
const universitesCtx = document.getElementById('universitesChart').getContext('2d');
new Chart(universitesCtx, {
    type: 'pie',
    data: {
        labels: [{% for stat in universites_stats %}'{{ stat.universite }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            data: [{% for stat in universites_stats %}{{ stat.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Graphique des pays
const paysCtx = document.getElementById('paysChart').getContext('2d');
new Chart(paysCtx, {
    type: 'bar',
    data: {
        labels: [{% for stat in pays_stats %}'{{ stat.pays }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Nombre de dossiers',
            data: [{% for stat in pays_stats %}{{ stat.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: '#36A2EB'
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Graphique d'évolution mensuelle
const evolutionCtx = document.getElementById('evolutionChart').getContext('2d');
new Chart(evolutionCtx, {
    type: 'line',
    data: {
        labels: [{% for stat in stats_mensuelles %}'{{ stat.mois }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Dossiers reçus',
            data: [{% for stat in stats_mensuelles %}{{ stat.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            borderColor: '#4BC0C0',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
</script>
{% endblock %} 